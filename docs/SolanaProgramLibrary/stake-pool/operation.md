# 操作
质押池是赚取质押奖励的另一种方法。这个链上程序将SOL汇集在一起，由质押者进行质押，允许SOL持有者质押并赚取奖励，而无需管理质押。

## 质押
SOL代币持有者可以通过将代币质押给一个或多个验证者来赚取奖励并帮助保护网络。质押代币的奖励基于当前的通胀率、网络上质押的SOL总数以及个别验证者的在线时间和佣金（费用）。

有关质押和质押编程的更多信息，请访问：
- https://solana.com/staking
- https://docs.solana.com/staking/stake-programming

## 背景
Solana的编程模型和本文档中使用的Solana术语的定义，请访问：
- https://docs.solana.com/apps
- https://docs.solana.com/terminology

## 动机
本文档旨在为质押池系统的主要参与者提供信息：

- 管理者：创建和管理质押池，赚取费用，可以更新费用、质押者和管理者
- 质押者：向池中添加和移除验证者，重新平衡验证者之间的质押，可以更新质押者
- 用户：向现有的质押池提供流动或质押SOL

在当前的迭代中，质押池接受活跃的质押或SOL，因此存款可能来自活跃的质押或SOL钱包。提款可以返回质押池账户中的一个完全活跃的质押账户，或者来自储备的SOL。

这意味着质押池管理者和质押者必须熟悉创建和委托质押，这比发送和接收SPL代币和SOL更为高级的操作。有关质押操作的更多信息，请访问：

- https://docs.solana.com/cli/delegate-stake
- https://docs.solana.com/cli/manage-stake-accounts

为了吸引更多的用户，鼓励质押池管理者通过[Token Swap](https://spl.solana.com/token-swap)等AMM为他们池子的代币提供市场。

或者，质押池管理者可以与钱包和质押账户提供商合作，进行直接的SOL存款。

## 操作
一个质押池管理者创建了一个质押池。此时，用户可以立即通过`deposit-sol`指令参与，将资金转移到储备中以换取池代币。

使用这些SOL存款，质押者通过使用`add-validator`将“验证者质押账户”添加到池子中，从而包括将从池子中接收委托的验证者。在这个命令中，质押池使用储备资金创建一个新的质押账户并将其委托给所需的验证者。

此时，用户也可以将质押账户存入池子中。为此，他们必须将质押账户委托给质押池中的一个验证者。如果质押池有一个首选的存款验证者，用户必须将他们的质押委托给该验证者的投票账户。

一旦质押在下一个纪元界限（最多2天）激活，用户就可以使用`deposit-stake`指令将他们的质押存入池中。

作为他们存款（SOL或质押）的交换，用户收到代表他们在池中的分数所有权的SPL代币。池中赚取的奖励的一部分作为一个纪元费用归池管理者所有。

随着时间的推移，随着池中的质押累积奖励，用户的分数所有权将比他们最初的存款更有价值。

当他们希望退出池时，用户可以使用`withdraw-sol`指令从质押池的储备中以质押池代币换取SOL。请注意，如果质押池的储备中没有足够的SOL，此操作将失败，这很正常，如果质押池管理者将池中的所有SOL都进行了质押。

或者，他们可以使用`withdraw-stake`指令以他们的SPL池代币换取已激活的质押账户。用户将立即得到一个SOL质押账户。在任何情况下，始终可以提取质押。

注意：当提取质押时，如果用户想要提取质押账户中的SOL，他们必须首先停用质押账户并等待到下一个纪元界限（最多2天）。一旦质押不活跃，他们可以自由提取SOL。

质押池质押者可以添加和移除验证者，或通过降低对验证者质押的份额，等待一个纪元将其移动到质押池的储备账户中，然后在另一个验证者上增加质押，来重新平衡池。

质押者添加新验证者的操作需要1.00228288 SOL来在验证者上创建质押账户，因此质押池储备需要流动性。

### 资金限制
为了给管理者更多的控制权，质押池允许通过三种不同的“资金授权”对进入池中的资金进行存款和提款限制：

SOL存款
质押存款
SOL提款

如果设置了该字段，则该授权必须签署相关指令。

例如，如果管理者设置了一个质押存款授权，那么该地址必须签署每个质押存款指令。

这在几种情况下也很有用：
- 控制谁可以向质押池存款
- 禁止某种形式的存款。例如，管理者只希望有SOL存款，因此他们设置了一个质押存款授权，使得只有在该授权签署交易的情况下才能存入质押账户。
- 维护模式。如果池需要时间来重置费用或以其他方式，管理者可以通过设置存款授权暂时限制新存款。

注意：为了确保用户资金的安全，总是允许质押提款。

## 资金安全
质押池程序的主要目标之一是始终允许池代币持有者随时提取他们的资金。

为此，让我们来看看质押池系统中的三种类别的质押账户：
- 验证者质押：活跃的质押账户，池中每个验证者一个
- 临时质押：正在激活或停用的质押账户，在停用后合并到储备中，或在激活后合并到验证者质押中，每个验证者一个
- 储备质押：不活跃的质押，被质押者用于重新平衡
此外，质押者可能会设定一个“首选提取账户”，强制用户从特定的质押账户提款。这是为了防止恶意存款者将质押池作为验证者之间的免费转换。

- 在处理提款时，优先顺序如下：
- 首选提款的验证者质押账户（如果设定）
- 验证者质押账户
- 临时质押账户
- 储备质押账户
- 完全移除验证者质押账户

如果有首选提款验证者，并且该验证者质押账户有任何SOL，用户必须从该账户提款。

如果该账户为空，或者没有设置首选提款验证者质押账户，那么用户必须从任何验证者质押账户中提款。

如果所有验证者质押账户都为空，这可能会发生如果质押池质押者一次性减少所有验证者上的质押，那么用户必须从任何临时质押账户中提款。

如果所有临时质押账户都为空，那么用户必须从储备中提款或完全移除验证者质押账户。

通过这种方式，用户的资金永远不会处于风险中，始终可以赎回。

## 附录
### 活跃质押
如前所述，质押池使用活跃质押来维持质押池代币的可互换性。完全激活的质押与不活跃的、正在激活的或正在停用的质押不同，因为质押的时间成本。

### 临时质押账户
每个验证者都会得到一个临时质押账户，因此质押者一次只能对验证者执行一个动作。不可能同时增加和减少对验证者的质押。质押者必须等到现有的临时质押账户在一个`update`指令中合并后才能执行新动作。

### 储备质押账户
每个质押池都初始化了一个未委托的储备质押账户，用于在重新平衡过程中持有未委托的质押。当质押者减少对验证者的质押时，并在经历一个纪元后，更新操作会将减少的质押合并到储备中。相反，每当质押者增加对验证者的质押时，就会从储备质押账户中提取lamports。

### 验证者列表账户
每个质押池都包含两个数据账户：质押池和验证者列表。

质押池包含有关池子的总体信息，包括费用、池代币铸造、管理金额等。

验证者列表包含有关池中每个验证者质押账户的特定信息。这些信息包括池在验证者上质押的SOL金额，以及在验证者上激活/停用的SOL金额。

每个质押池都必须有自己的验证者列表账户，否则初始化时会失败。

### 交易大小
Solana交易处理器有两个重要的限制：

- 整体交易的大小，限制在大约 1 MTU /数据包
- 每个指令的计算预算

一个质押池可能管理数百个质押账户，因此不可能在一条指令中更新质押池的总价值。幸运的是，命令行工具将会拆分交易，以避免大型池子遇到这个问题。
